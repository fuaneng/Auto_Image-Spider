# ![é¡¹ç›®åœ°å€](https://github.com/fuaneng/Auto_Image-Spider)

# yande.re å›¾ç‰‡çˆ¬è™« (yande_re_spider_v4)

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäº Python å’Œ Selenium çš„é«˜çº§ç½‘ç»œçˆ¬è™«ï¼Œä¸“ä¸ºæŠ“å– `yande.re` ç½‘ç«™å›¾ç‰‡è€Œè®¾è®¡ã€‚å®ƒåˆ©ç”¨å¤šçº¿ç¨‹å¹¶è¡Œå¤„ç†å¤šä¸ªæ ‡ç­¾é¡µé¢çš„è§£æå’Œå›¾ç‰‡ä¸‹è½½ä»»åŠ¡ï¼Œå¹¶é›†æˆäº† **Redis æˆ–å†…å­˜å»é‡**ã€**æ–­ç‚¹ç»­ä¼ **ã€**åŸå›¾æ£€æµ‹** ç­‰åŠŸèƒ½ï¼Œä»¥å®ç°é«˜æ•ˆã€ç¨³å®šçš„æ•°æ®é‡‡é›†ã€‚

## ğŸš€ ä¸»è¦ç‰¹æ€§

* **æ ‡ç­¾å¹¶è¡Œå¤„ç†:** ä½¿ç”¨ `TagWorker` çº¿ç¨‹æ± åŒæ—¶å¤„ç†å¤šä¸ªæœç´¢æ ‡ç­¾é¡µã€‚
* **å†…å®¹å¹¶è¡Œè§£æ:** åœ¨æ¯ä¸ªæ ‡ç­¾é¡µå†…ï¼Œä½¿ç”¨ `Parser` çº¿ç¨‹æ± å¿«é€Ÿè§£æå›¾ç‰‡é“¾æ¥åŠå…ƒæ•°æ®ã€‚
* **å¼‚æ­¥ä¸‹è½½:** ä½¿ç”¨ `Downloader` çº¿ç¨‹æ± è¿›è¡Œé«˜é€Ÿå›¾ç‰‡ä¸‹è½½ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼ ã€‚
* **å»é‡æœºåˆ¶:** æ”¯æŒ **Redis** æˆ– **å†…å­˜ Set** å¯¹å·²å¤„ç†çš„å›¾ç‰‡ URL MD5 è¿›è¡Œå»é‡ï¼Œé¿å…é‡å¤ä¸‹è½½ã€‚
* **æ–­ç‚¹ç»­çˆ¬:** é€šè¿‡ `processed_tags.txt` æ–‡ä»¶è®°å½•å·²å®Œæˆå¤„ç†çš„æ ‡ç­¾ï¼Œä¸‹æ¬¡è¿è¡Œæ—¶è‡ªåŠ¨è·³è¿‡ï¼Œå®ç°æ ‡ç­¾çº§åˆ«çš„æ–­ç‚¹ç»­çˆ¬ã€‚
* **åŸå›¾ä¼˜å…ˆ:** å°è¯•æ£€æµ‹å¹¶ä¸‹è½½æ›´é«˜æ¸…çš„ PNG æ ¼å¼åŸå›¾ã€‚
* **è¯¦ç»†è®°å½•:** å°†å›¾ç‰‡å…ƒæ•°æ®ï¼ˆè¯„åˆ†ã€æ ‡ç­¾ã€URL ç­‰ï¼‰ç»Ÿä¸€è®°å½•åˆ° CSV æ–‡ä»¶ã€‚

## ğŸ› ï¸ ç¯å¢ƒå‡†å¤‡

### 1. Python ç¯å¢ƒ

ç¡®ä¿æ‚¨çš„ç³»ç»Ÿå·²å®‰è£… Python 3.8+ã€‚

### 2. ä¾èµ–å®‰è£…

ä½¿ç”¨ `pip` å®‰è£…æ‰€éœ€çš„ Python åº“ï¼š

```bash
pip install selenium requests pandas redis
````

### 3\. Chrome æµè§ˆå™¨ä¸é©±åŠ¨

æœ¬é¡¹ç›®ä¾èµ– Chrome æµè§ˆå™¨å’Œå¯¹åº”çš„ `ChromeDriver`ã€‚

1.  **å®‰è£… Chrome æµè§ˆå™¨**ã€‚
2.  **ä¸‹è½½ ChromeDriver:** ç¡®ä¿ä¸‹è½½çš„ `ChromeDriver` ç‰ˆæœ¬ä¸æ‚¨çš„ Chrome æµè§ˆå™¨ç‰ˆæœ¬å…¼å®¹ã€‚
      * ä¸‹è½½åœ°å€ï¼š[ChromeDriver å®˜æ–¹ç½‘ç«™](https://chromedriver.chromium.org/downloads)
3.  **é…ç½®è·¯å¾„:** å°† `chromedriver.exe` çš„è·¯å¾„é…ç½®åˆ°ä¸»ç¨‹åº `if __name__ == '__main__':` å—ä¸­çš„ `chrome_driver_path` å˜é‡ã€‚

### 4\. Redis (å¯é€‰ï¼Œæ¨è)

å¦‚æœå¸Œæœ›ä½¿ç”¨æ›´å¥å£®çš„å»é‡æœºåˆ¶ï¼Œå»ºè®®å®‰è£…å¹¶è¿è¡Œ Redis æœåŠ¡å™¨ã€‚

  * é»˜è®¤è¿æ¥ä¿¡æ¯ï¼š`localhost:6379`ã€‚å¦‚æœ Redis ä¸å¯ç”¨ï¼Œç¨‹åºå°†è‡ªåŠ¨é€€åŒ–ä¸ºå†…å­˜å»é‡ã€‚

## âš™ï¸ ä½¿ç”¨è¯´æ˜

### 1\. é…ç½®æ–‡ä»¶

åœ¨è¿è¡Œè„šæœ¬å‰ï¼Œè¯·å‡†å¤‡å¥½ä»¥ä¸‹æ–‡ä»¶ï¼š

#### A. æ ‡ç­¾æ–‡ä»¶ (`ram_tag_å‘¨.txt`)

åˆ›å»ºä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œæ¯è¡ŒåŒ…å«ä¸€ä¸ªè¦çˆ¬å–çš„ `yande.re` æœç´¢ URL çš„è·¯å¾„ã€‚

> **æ³¨æ„:** è„šæœ¬ä¼šè‡ªåŠ¨å°†æ­¤è·¯å¾„å‰ç¼€åŠ ä¸Š `https://yande.re/`ã€‚

**ç¤ºä¾‹ `ram_tag_å‘¨.txt` å†…å®¹:**

```text
post?tags=date%3Aday%3D1+month%3D1+year%3D2024
post?tags=date%3Aday%3D8+month%3D1+year%3D2024
post?tags=some_other_tag
```

#### B. ä¸»ç¨‹åºé…ç½®

åœ¨è„šæœ¬çš„ `if __name__ == '__main__':` å—ä¸­ä¿®æ”¹ä»¥ä¸‹å‚æ•°ï¼š

```python
if __name__ == '__main__':
    # ã€å¿…é¡»ä¿®æ”¹ã€‘ChromeDriver çš„ç»å¯¹è·¯å¾„
    chrome_driver_path = r'C:\Program Files\Google\chromedriver-win64\chromedriver.exe' 
    # ã€å¿…é¡»ä¿®æ”¹ã€‘æ‰€æœ‰è¾“å‡ºæ–‡ä»¶ï¼ˆCSVã€å›¾ç‰‡æ–‡ä»¶å¤¹ã€è¿›åº¦æ–‡ä»¶ï¼‰çš„ä¿å­˜æ ¹ç›®å½•
    save_dir = r'R:\py\Auto_Image-Spider\yande.re\output_v4' 
    # ã€å¿…é¡»ä¿®æ”¹ã€‘æ ‡ç­¾æ–‡ä»¶çš„è·¯å¾„
    tag_file_path = r'R:\py\Auto_Image-Spider\yande.re\ram_tag_å‘¨.txt'
    
    # å®ä¾‹åŒ–çˆ¬è™«å¹¶é…ç½®çº¿ç¨‹æ•°
    spider = yande_re(
        chrome_driver_path, 
        use_headless=True,            # æ˜¯å¦å¯ç”¨æ— å¤´æ¨¡å¼ (å½“å‰ä»£ç å·²æ³¨é‡Šæ‰ï¼Œå¯å¿½ç•¥æ­¤å‚æ•°)
        download_workers=10,          # ã€æ¨èé…ç½®ã€‘ä¸‹è½½çº¿ç¨‹æ•°
        tag_workers=3                 # ã€æ¨èé…ç½®ã€‘æ ‡ç­¾å¹¶è¡Œå¤„ç†æ•°
    )
    
    # å¯åŠ¨ä¸»ç¨‹åº
    spider.main(
        save_dir=save_dir, 
        tag_file_path=tag_file_path, 
        enable_download=True         # ã€å…³é”®ã€‘è®¾ä¸º True å¼€å¯ä¸‹è½½å›¾ç‰‡ï¼Œè®¾ä¸º False ä»…è§£æå’Œè®°å½• CSV
    )
```

### 2\. è¿è¡Œçˆ¬è™«

```bash
python your_script_name.py
```

## ğŸ“‚ è¾“å‡ºç»“æ„

è„šæœ¬è¿è¡Œæ—¶ä¼šåœ¨ `save_dir` ç›®å½•ä¸‹åˆ›å»ºä»¥ä¸‹ç»“æ„ï¼š

```
output_v4/
â”œâ”€â”€ all_records_yande_re_v4.csv    # æ‰€æœ‰å›¾ç‰‡çš„å…ƒæ•°æ®è®°å½•
â”œâ”€â”€ processed_tags.txt             # å·²æˆåŠŸå¤„ç†å®Œæˆçš„æ ‡ç­¾åˆ—è¡¨ (ç”¨äºæ–­ç‚¹ç»­çˆ¬)
â””â”€â”€ images/                        # å›¾ç‰‡ä¿å­˜æ ¹ç›®å½•
    â”œâ”€â”€ 2024å¹´1æœˆ1æ—¥ - 2024å¹´1æœˆ7æ—¥ï¼ˆ2024å¹´ç¬¬1å‘¨ï¼‰/
    â”‚   â””â”€â”€ image_name_1.png
    â”‚   â””â”€â”€ image_name_2.jpg
    â””â”€â”€ some_other_tag/
        â””â”€â”€ image_name_3.png
```

## ğŸ’¡ æ ¸å¿ƒä»£ç è§£æ

### ç±» `yande_re`

è¿™æ˜¯æ•´ä¸ªçˆ¬è™«çš„æ ¸å¿ƒç±»ã€‚

| æ–¹æ³•å | æè¿° |
| :--- | :--- |
| `__init__` | åˆå§‹åŒ– Selenium é©±åŠ¨è·¯å¾„ã€Redis è¿æ¥ã€çº¿ç¨‹æ± ï¼ˆä¸‹è½½ã€æ ‡ç­¾ï¼‰ä»¥åŠé…ç½®å‚æ•°ã€‚ |
| `main` | ä¸»å…¥å£å‡½æ•°ã€‚è´Ÿè´£è®¾ç½®ç›®å½•ã€åŠ è½½å·²å¤„ç†æ ‡ç­¾ã€è¡¥å…¨æœªå®Œæˆä¸‹è½½ï¼Œå¹¶å¯åŠ¨ `tag_workers` çº¿ç¨‹æ± ã€‚ |
| `process_tag` | **æ ‡ç­¾å¤„ç†çº¿ç¨‹**ã€‚ä¸ºæ¯ä¸ªæ ‡ç­¾ç‹¬ç«‹åˆ›å»ºä¸€ä¸ª `WebDriver` å®ä¾‹å’Œ `Parser` çº¿ç¨‹æ± ï¼Œè´Ÿè´£è¿›å…¥æ ‡ç­¾é¡µå¹¶æå–æ‰€æœ‰å›¾ç‰‡å¡ç‰‡ã€‚ |
| `process_image_card` | **è§£æçº¿ç¨‹**ã€‚ä»å•ä¸ªå›¾ç‰‡å¡ç‰‡ä¸­æå– URLã€æ ‡é¢˜ç­‰ä¿¡æ¯ï¼Œè¿›è¡Œå»é‡æ£€æŸ¥ï¼Œå†™å…¥ CSVï¼Œå¹¶å°†ä¸‹è½½ä»»åŠ¡æäº¤ç»™ä¸‹è½½çº¿ç¨‹æ± ã€‚ |
| `download_image` | **ä¸‹è½½çº¿ç¨‹**ã€‚æ‰§è¡Œå®é™…çš„å›¾ç‰‡ä¸‹è½½æ“ä½œï¼Œæ”¯æŒæ–­ç‚¹ä¸‹è½½ï¼ˆ`.downloading` ä¸´æ—¶æ–‡ä»¶æœºåˆ¶ï¼‰ã€‚ |
| `is_duplicate` | åˆ©ç”¨ Redis æˆ–å†…å­˜ Set æ£€æŸ¥å¹¶è®°å½•å›¾ç‰‡ URL çš„ MD5 å“ˆå¸Œï¼Œå®ç°å»é‡ã€‚ |
| `get_hq_image_url` | å°è¯•å°†ä½åˆ†è¾¨ç‡çš„ JPG/JPEG URL è½¬æ¢ä¸ºæ›´é«˜æ¸…çš„ PNG æ ¼å¼åŸå›¾ URLï¼Œå¹¶é€šè¿‡ `requests.head` æ£€æŸ¥åŸå›¾æ˜¯å¦å­˜åœ¨ã€‚ |
| `parse_tag_to_week_label` | å°†åŒ…å«æ—¥æœŸä¿¡æ¯çš„ URL æ ‡ç­¾è½¬æ¢ä¸ºæ›´å‹å¥½çš„â€œå¹´-æœˆ-æ—¥ï¼ˆå‘¨æ•°ï¼‰â€æ ¼å¼ä½œä¸ºä¿å­˜æ–‡ä»¶å¤¹åã€‚ |
| `mark_tag_as_processed` | å°†å·²æˆåŠŸå¤„ç†çš„æ ‡ç­¾å†™å…¥è¿›åº¦æ–‡ä»¶ (`processed_tags.txt`)ï¼Œç”¨äºæ–­ç‚¹ç»­çˆ¬ã€‚ |
| `resume_incomplete_downloads` | è¯»å– CSV è®°å½•ï¼Œæ£€æŸ¥å›¾ç‰‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨æˆ–æ˜¯å¦å¸¦æœ‰ `.downloading` ä¸´æ—¶æ–‡ä»¶ï¼Œå¹¶é‡æ–°æäº¤æœªå®Œæˆçš„ä¸‹è½½ä»»åŠ¡ã€‚ |

### å¹¶å‘è®¾è®¡

| çº¿ç¨‹æ± /æ¨¡å¼ | ä½œç”¨ | çº¿ç¨‹æ•° | ç›®çš„ |
| :--- | :--- | :--- | :--- |
| `TagWorker` (æ ‡ç­¾) | å¹¶è¡Œå¤„ç†ä¸åŒçš„æœç´¢æ ‡ç­¾/é¡µé¢ã€‚ | `tag_workers` | åŠ é€Ÿå¤šæ ‡ç­¾çš„çˆ¬å–è¿›åº¦ã€‚ |
| `Parser` (è§£æ) | åœ¨å•ä¸ªæ ‡ç­¾é¡µå†…ï¼Œå¹¶è¡Œè§£æå›¾ç‰‡å¡ç‰‡ï¼Œæå–ä¿¡æ¯ã€‚ | `parser_workers` | åŠ é€Ÿé¡µé¢å…ƒç´ çš„æå–é€Ÿåº¦ã€‚ |
| `Downloader` (ä¸‹è½½) | å¼‚æ­¥æ‰§è¡Œæ–‡ä»¶ä¸‹è½½ä»»åŠ¡ã€‚ | `download_workers` | å°†è€—æ—¶çš„ç½‘ç»œ I/O æ“ä½œä¸çˆ¬å–è§£æé€»è¾‘åˆ†ç¦»ã€‚ |

```
```